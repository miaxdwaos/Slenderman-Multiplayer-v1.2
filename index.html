<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>GameContentSlender - P2P</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        canvas { display: block; margin: auto; border: 2px solid #333; }
        #ui { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .menu-btn { padding: 10px 20px; margin: 10px; cursor: pointer; background: #440000; color: white; border: none; }
        #hud { position: absolute; top: 10px; left: 10px; pointer-events: none; }
    </style>
</head>
<body>

    <div id="hud" style="display:none;">Páginas: <span id="pageCount">0</span>/8</div>

    <div id="ui">
        <h1>SLENDER P2P</h1>
        <button class="menu-btn" onclick="startSolo()">SOLITARIO</button>
        <br>
        <button class="menu-btn" onclick="showMulti()">MULTIJUGADOR</button>
        <div id="multi-tools" style="display:none; margin-top:20px;">
            <p>Tu ID: <b id="my-id">...</b></p>
            <input type="text" id="join-id" placeholder="Pegar ID del amigo">
            <button onclick="connectToPeer()">Unirse a Room</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        // --- Configuración y Sprites ---
        const GameContentSlender = {
            PersonSpriteheh: "blue", // Representación del jugador
            SlenderColor: "black",
            PageColor: "white"
        };

        let player = { x: 400, y: 300, size: 20, speed: 3 };
        let remotePlayer = { x: -100, y: -100, active: false };
        let slender = { x: 50, y: 50, size: 30, speed: 1.5 };
        let pages = [];
        let collectedPages = 0;
        let gameRunning = false;
        let isMultiplayer = false;

        // --- PeerJS (P2P) ---
        let peer;
        let conn;

        function initPeer() {
            peer = new Peer();
            peer.on('open', (id) => { document.getElementById('my-id').innerText = id; });
            peer.on('connection', (connection) => {
                conn = connection;
                setupDataListener();
                isMultiplayer = true;
                startGame();
            });
        }

        function connectToPeer() {
            const targetId = document.getElementById('join-id').value;
            conn = peer.connect(targetId);
            conn.on('open', () => {
                setupDataListener();
                isMultiplayer = true;
                startGame();
            });
        }

        function setupDataListener() {
            conn.on('data', (data) => {
                remotePlayer.x = data.x;
                remotePlayer.y = data.y;
                remotePlayer.active = true;
                if(data.pages !== undefined) collectedPages = data.pages;
            });
        }

        // --- Lógica del Juego ---
        function startSolo() {
            isMultiplayer = false;
            startGame();
        }

        function showMulti() {
            document.getElementById('multi-tools').style.display = 'block';
            initPeer();
        }

        function startGame() {
            document.getElementById('ui').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            gameRunning = true;
            spawnPages();
            gameLoop();
        }

        function spawnPages() {
            for(let i=0; i<8; i++) {
                pages.push({
                    x: Math.random() * (canvas.width - 20),
                    y: Math.random() * (canvas.height - 20),
                    collected: false
                });
            }
        }

        const keys = {};
        window.onkeydown = (e) => keys[e.key] = true;
        window.onkeyup = (e) => keys[e.key] = false;

        function update() {
            // Movimiento jugador local
            if (keys['ArrowUp'] || keys['w']) player.y -= player.speed;
            if (keys['ArrowDown'] || keys['s']) player.y += player.speed;
            if (keys['ArrowLeft'] || keys['a']) player.x -= player.speed;
            if (keys['ArrowRight'] || keys['d']) player.x += player.speed;

            // Persecución Slender (persigue al más cercano)
            let target = player;
            if (remotePlayer.active) {
                let distLocal = Math.hypot(slender.x - player.x, slender.y - player.y);
                let distRemote = Math.hypot(slender.x - remotePlayer.x, slender.y - remotePlayer.y);
                if (distRemote < distLocal) target = remotePlayer;
            }

            let angle = Math.atan2(target.y - slender.y, target.x - slender.x);
            slender.x += Math.cos(angle) * slender.speed;
            slender.y += Math.sin(angle) * slender.speed;

            // Colisión Páginas
            pages.forEach(p => {
                if(!p.collected && Math.hypot(player.x - p.x, player.y - p.y) < 20) {
                    p.collected = true;
                    collectedPages++;
                    document.getElementById('pageCount').innerText = collectedPages;
                }
            });

            // Colisión Slender (Muerte)
            if (Math.hypot(player.x - slender.x, player.y - slender.y) < 25) {
                alert("Slenderman te atrapó. Páginas recogidas: " + collectedPages);
                location.reload();
            }

            // Enviar datos P2P
            if (isMultiplayer && conn && conn.open) {
                conn.send({ x: player.x, y: player.y, pages: collectedPages });
            }
            
            if(collectedPages >= 8) {
                alert("¡Has escapado con las 8 páginas!");
                location.reload();
            }
        }

        function draw() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Dibujar Páginas
            ctx.fillStyle = GameContentSlender.PageColor;
            pages.forEach(p => {
                if(!p.collected) ctx.fillRect(p.x, p.y, 10, 15);
            });

            // Dibujar Slender (Cuerpo negro, cabeza blanca)
            ctx.fillStyle = "black";
            ctx.fillRect(slender.x, slender.y, slender.size, slender.size * 2);
            ctx.fillStyle = "white";
            ctx.fillRect(slender.x + 5, slender.y - 15, slender.size - 10, 15);

            // Dibujar Jugador Local (PersonSpriteheh)
            ctx.fillStyle = GameContentSlender.PersonSpriteheh;
            ctx.fillRect(player.x, player.y, player.size, player.size);

            // Dibujar Jugador Remoto
            if (remotePlayer.active) {
                ctx.fillStyle = "green";
                ctx.fillRect(remotePlayer.x, remotePlayer.y, player.size, player.size);
            }
        }

        function gameLoop() {
            if (!gameRunning) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>